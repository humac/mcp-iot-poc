version: '3.8'

services:
  weather-mcp:
    build:
      context: ./servers/weather-mcp
      dockerfile: Dockerfile
    container_name: weather-mcp
    ports:
      - "8081:8080"
    environment:
      - LATITUDE=${LATITUDE:-45.35}
      - LONGITUDE=${LONGITUDE:-75.75}
      - TIMEZONE=${TIMEZONE:-America/Toronto}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mcp-network

  homeassistant-mcp:
    build:
      context: ./servers/homeassistant-mcp
      dockerfile: Dockerfile
    container_name: homeassistant-mcp
    ports:
      - "8082:8080"
    environment:
      - HA_URL=${HA_URL}
      - HA_TOKEN=${HA_TOKEN}
      - HA_ENTITY_ID=${HA_ENTITY_ID:-climate.my_ecobee}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mcp-network

  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: climate-agent
    ports:
      - "8080:8080"
    environment:
      - OLLAMA_URL=${OLLAMA_URL}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:8b}
      - WEATHER_MCP_URL=http://weather-mcp:8080
      - HA_MCP_URL=http://homeassistant-mcp:8080
      - CHECK_INTERVAL_MINUTES=${CHECK_INTERVAL_MINUTES:-30}
      - MIN_TEMP=${MIN_TEMP:-17}
      - MAX_TEMP=${MAX_TEMP:-23}
      - LATITUDE=${LATITUDE:-45.35}
      - LONGITUDE=${LONGITUDE:-75.75}
      - TIMEZONE=${TIMEZONE:-America/Toronto}
    volumes:
      - agent-data:/app/data
    depends_on:
      weather-mcp:
        condition: service_healthy
      homeassistant-mcp:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - mcp-network

volumes:
  agent-data:
    name: climate-agent-data

networks:
  mcp-network:
    name: mcp-network
    driver: bridge
