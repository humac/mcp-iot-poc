# MCP IoT PoC - Windsurf Guidelines

## Project Overview
AI-powered thermostat control using Model Context Protocol (MCP). Compares AI decisions vs rule-based automation.

**Stack:**
- **Agent**: Python 3.11, FastAPI, APScheduler, SQLite
- **MCP Servers**: Python 3.11, Starlette, httpx, mcp-sdk
- **LLM**: Ollama (llama3.1:8b) - external dependency
- **Infrastructure**: Docker Compose

## Architecture

```
agent/ (climate_agent)     â†’ Main app, port 8080
servers/weather-mcp/       â†’ Open-Meteo API wrapper, port 8081
servers/homeassistant-mcp/ â†’ HA REST API wrapper, port 8082
```

## Critical Rules ðŸš¨

1. **No SSWS/API Keys**: All auth uses OAuth2 or Bearer tokens
2. **Temperature Bounds**: Always enforce MIN_TEMP/MAX_TEMP (17-23Â°C default)
3. **MCP Protocol**: Use JSON-RPC 2.0 over HTTP POST to `/mcp`
4. **Tool Validation**: LLMs may pass invalid params - always validate inputs
5. **Async Only**: All HTTP calls must be async with `httpx.AsyncClient`

## Key Files

| File | Purpose |
|------|---------|
| `agent/src/climate_agent/main.py` | Agent loop, scheduler, baseline comparison |
| `agent/src/climate_agent/mcp_client.py` | MCP protocol client |
| `agent/src/climate_agent/ollama_client.py` | LLM integration |
| `agent/src/climate_agent/decision_logger.py` | SQLite logging + settings |
| `agent/src/climate_agent/web_dashboard.py` | FastAPI dashboard |
| `servers/*/src/*/server.py` | MCP server implementations |

## Development

```bash
# Run locally
docker-compose up -d

# View logs
docker-compose logs -f agent

# Test MCP servers
curl http://localhost:8081/health
curl -X POST http://localhost:8081/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "method": "tools/list", "id": 1}'
```

## Code Review Status

See `CODE_REVIEW.md` and `CODE_REVIEW_IMPLEMENTATION_PLAN.md` for tracked issues.

- **Phase 1 (Demo fixes)**: âœ… Complete
- **Phase 2 (Reliability)**: In progress
- **Phase 3-5**: Pending

## Common Patterns

### Adding a new MCP tool
1. Add `Tool()` to `list_tools()` in server.py
2. Handle in `call_tool()` switch statement
3. Include input validation for LLM quirks

### Adding a new setting
Use `DecisionLogger.get_setting()` - auto-creates if missing:
```python
value = await self.logger.get_setting("key", "default", "description", "Category")
```
